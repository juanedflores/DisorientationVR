<!DOCTYPE html>
<html>
  <head>
    <title>Hello, World! - A-Frame</title>

    <meta name="description" content="Hello, World! - A-Frame" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,shrink-to-fit=no,user-scalable=no,maximum-scale=1"
    />

    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.2.0/dist/aframe-environment-component.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^4.1.1/dist/aframe-event-set-component.js"></script>

    <script src="https://mixedreality.mozilla.org/ammo.js/builds/ammo.wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-extras/dist/aframe-physics-extras.js"></script>
    <!-- <script src="https://rawcdn.githack.com/kylebakerio/aframe-physics-system/f7117be8f83cb75ff870941883b7973ff92d0a34/dist/aframe-physics-system.js"></script> -->

    <!-- User Components -->
    <script src="https://unpkg.com/aframe-audio-analyser@1.0.0/dist/aframe-audio-analyser.umd.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>

    <script src="../components/audioanalyser-volume-bind.js"></script>
    <script src="../components/audioanalyser-waveform.js"></script>

    <script>
      AFRAME.registerComponent('push', {
        init: function () {
          var el = this.el;
          el.addEventListener('collidestart', function () {
            const impulse = new Ammo.btVector3(1.4, 1, 0);
            const pos = new Ammo.btVector3(0, 0, 0);
            el.body.applyImpulse(impulse, pos);
            Ammo.destroy(impulse);
            Ammo.destroy(pos);
          });
        },
      });
    </script>
  </head>
  <body>
    <a-scene physics="debug:true; gravity: 1; driver: ammo;">
      <a-assets>
        <audio id="song" src="../music/bina48.wav" autoplay loop></audio>
      </a-assets>

      <!-- Player -->
      <a-entity
        id="rig"
        movement-controls="fly: false"
        position="0 0 5"
        geometry="primitive: cylinder; height: 2; radius: 0.8"
        material="color: green; wireframe: true"
        ammo-body="type: kinematic; emitCollisionEvents: true; mass: 3; gravity: 0 -9.8 0"
        ammo-shape="type: cylinder"
      >
        <a-entity id="cam" camera position="0 1.6 0" look-controls></a-entity>
      </a-entity>

      <!-- <a-entity fractal="foo: bar"></a-entity> -->

      <!-- <a-sound -->
      <!--   src="src: url(../music/bina48.wav)" -->
      <!--   position="0 0 -10" -->
      <!--   id="audio" -->
      <!--   autoplay="false" -->
      <!-- ></a-sound> -->

      <a-entity
        id="analyser"
        audioanalyser="src: #song"
        audioanalyser-waveform="radius: 0.5"
        rotation="90 0 0"
        position="0 50 0"
      ></a-entity>

      <a-light
        audioanalyser-volume-bind="analyserEl: #analyser; component: light; property: intensity; max: 2.2; multiplier: .018"
        type="point"
        position="1 2 1"
      ></a-light>

      <a-entity
        id="nyan"
        geometry="primitive: box"
        ammo-body="type: dynamic; emitCollisionEvents: true;"
        ammo-shape="type: box"
        width="1"
        height="1"
        depth="1"
        position="2 10 0"
        color="blue"
        obj-model="obj: url(cube.obj)"
      ></a-entity>

      <!-- Blocks -->
      <a-plane
        ammo-body="type: static"
        ammo-shape="type: box"
        position="0 0 -4"
        rotation="-90 0 0"
        width="100"
        height="100"
        color="yellow"
      ></a-plane>

      <a-box
        ammo-body="type: dynamic"
        ammo-shape="type: box"
        position="0 4 -2"
        width="3"
        height="2"
        depth="1"
        color="red"
      ></a-box>

      <a-box
        ammo-body="type: dynamic"
        ammo-shape="type: box"
        position="2 10 0"
        width="1"
        height="1"
        depth="1"
        color="blue"
      ></a-box>

      <a-entity
        geometry="primitive: box"
        push
        ammo-body="type: dynamic; emitCollisionEvents: true;"
        ammo-shape="type: box"
        position="-3 4 -2"
        width="1"
        height="1"
        depth="1"
        material="color: green"
      ></a-entity>

      <!-- Environment -->
      <a-entity environment="preset: japan; ground: flat;"></a-entity>
      <!-- Sky -->
      <!-- <a-sky radius="4000" color="#6EBAA7"></a-sky> -->
    </a-scene>
  </body>
  <script charset="utf-8">
    var playerEl = document.querySelector('#cam');
    playerEl.addEventListener('collide', function (e) {
      console.log('Player has collided with body #' + e.detail.targetEl.id);
      e.detail.targetEl; // Other entity, which playerEl touched.
    });
  </script>

  <!-- <script charset="utf-8"> -->
  <!--   var el = sceneEl.querySelector('#nyan'); -->
  <!--   const force = new Ammo.btVector3(0, 1, -0); -->
  <!--   const pos = new Ammo.btVector3( -->
  <!--     el.object3D.position.x, -->
  <!--     el.object3D.position.y, -->
  <!--     el.object3D.position.z -->
  <!--   ); -->
  <!--   el.body.applyForce(force, pos); -->
  <!--   Ammo.destroy(force); -->
  <!--   Ammo.destroy(pos); -->
  <!-- </script> -->
</html>
